<html>

<head>
    <script type="text/javascript" src="//code.jquery.com/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="//www.google.com/jsapi"></script>

    <script type="text/javascript">

        function drawChart() {

            
            $.ajax({
                url: "monitored.txt",
                context: document.body
            }).done(function (deviceMacsTxt) {

                let deviceMacs = deviceMacsTxt.split(" ");
                deviceMacs.forEach(m => {
                    
                    $.ajax({
                        url: m+".log",
                        context: document.body
                    }).done(function (log) {
                        debugger;

                    });


                });
                

            });

            $.ajax({
                url: "temps.log",
                context: document.body
            }).done(function () {

                //                 var temps = `ts:2021-11-28T22:12:29+01:00 t:14.26 h:63 b:2.851
                // ts:2021-11-28T22:13:08+01:00 t:14.26 h:63 b:2.851
                // ts:2021-11-28T22:24:00+01:00 t:14.24 h:63 b:2.851
                // `;

                var temps = arguments[2].responseText.split("\n").filter(Boolean);
                var data = new google.visualization.DataTable();
                //data.addColumn('string', 'time');
                data.addColumn('date', 'Time Of Readout')
                data.addColumn('number', 'Temperature');
                data.addColumn('number', 'Humidity');

                temps.forEach((l, i) => {
                    let readings = l.split(" ");
                    //console.log(readings);
                    let time = readings[0].split("ts:")[1];
                    let temperature = readings[1].split("t:")[1];
                    let humidity = readings[2].split("h:")[1];
                    let battery = readings[3].split("b:")[1];

                    data.addRow();
                    data.setValue(i, 0, new Date(time));
                    data.setValue(i, 1, parseFloat(temperature));
                    data.setValue(i, 2, parseFloat(humidity));

                });

                var dateFormatter = new google.visualization.DateFormat({ pattern: 'dd/MM/yyyy HH:mm' });
                dateFormatter.format(data, 0); // Apply formatter to first column

                let chart = new google.visualization.LineChart(document.getElementById('chart'));
                let options = {
                    // Gives each series an axis that matches the vAxes number below.
                    series: {
                        0: { targetAxisIndex: 0 },
                        1: { targetAxisIndex: 1 }
                    },
                    // Adds titles to each axis.
                    vAxes: {
                        0: { title: "Temp [Â°C]", baseline: 0 }, //start Y axis at value 0
                        1: { title: "Humidity %", baseline: 0 }
                    },
                    // Set date formatter for X labels
                    hAxis: {
                        format: 'dd/MM/yyyy HH:mm'
                    },
                    width: 1000,
                    height: 240,
                    title: 'Osp',
                    pointSize: 5
                };
                chart.draw(data, options);
            });

        }

        google.load("visualization", "1", { packages: ["corechart"] });
        google.setOnLoadCallback(drawChart);

        setInterval(drawChart, 120 * 1000);

    </script>
</head>

<body>
    <div id="chart"></div>
</body>

</html>